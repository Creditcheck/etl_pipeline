{
  "job": "vozidla_dovoz_multi",
  "parser": {
    "kind": "csv",
    "options": {
      "comma": ",",
      "expected_fields": 3,
      "has_header": true,
      "header_map": {
        "Datum dovozu": "datum_dovozu",
        "PČV": "pcv",
        "Stát": "stat"
      },
      "trim_space": true
    }
  },
  "runtime": {
    "batch_size": 1024,
    "channel_buffer": 256,
    "loader_workers": 2,
    "reader_workers": 1,
    "transform_workers": 2
  },
  "source": {
    "file": {
      "path": "/home/zippy/projects/data/file.csv"
    },
    "kind": "file"
  },
  "storage": {
    "db": {
      "dsn": "file:etl.db?cache=shared&_fk=1",
      "mode": "multi_table",
      "tables": [
        {
          "auto_create_table": true,
          "columns": [
            {
              "name": "pcv",
              "nullable": false,
              "type": "bigint"
            }
          ],
          "constraints": [
            {
              "columns": [
                "pcv"
              ],
              "kind": "unique"
            }
          ],
          "load": {
            "cache": {
              "key_column": "pcv",
              "prewarm": true,
              "value_column": "vehicle_id"
            },
            "conflict": {
              "action": "do_nothing",
              "target_columns": [
                "pcv"
              ]
            },
            "from_rows": [
              {
                "source_field": "pcv",
                "target_column": "pcv"
              }
            ],
            "kind": "dimension",
            "returning": [
              "vehicle_id",
              "pcv"
            ]
          },
          "name": "vehicles",
          "primary_key": {
            "name": "vehicle_id",
            "type": "serial"
          }
        },
        {
          "auto_create_table": true,
          "columns": [
            {
              "name": "name",
              "nullable": false,
              "type": "varchar(100)"
            }
          ],
          "constraints": [
            {
              "columns": [
                "name"
              ],
              "kind": "unique"
            }
          ],
          "load": {
            "cache": {
              "key_column": "name",
              "prewarm": true,
              "value_column": "country_id"
            },
            "conflict": {
              "action": "do_nothing",
              "target_columns": [
                "name"
              ]
            },
            "from_rows": [
              {
                "source_field": "stat",
                "target_column": "name",
                "transform": [
                  {
                    "kind": "trim"
                  }
                ]
              }
            ],
            "kind": "dimension",
            "returning": [
              "country_id",
              "name"
            ]
          },
          "name": "countries",
          "primary_key": {
            "name": "country_id",
            "type": "serial"
          }
        },
        {
          "auto_create_table": true,
          "columns": [
            {
              "name": "vehicle_id",
              "nullable": false,
              "references": "vehicles(vehicle_id)",
              "type": "int"
            },
            {
              "name": "country_id",
              "nullable": false,
              "references": "countries(country_id)",
              "type": "int"
            },
            {
              "name": "import_date",
              "nullable": true,
              "type": "date"
            }
          ],
          "constraints": [
            {
              "columns": [
                "vehicle_id",
                "country_id"
              ],
              "kind": "unique"
            }
          ],
          "load": {
            "dedupe": {
              "action": "do_nothing",
              "conflict_columns": [
                "vehicle_id",
                "country_id"
              ]
            },
            "from_rows": [
              {
                "lookup": {
                  "match": {
                    "pcv": "pcv"
                  },
                  "on_missing": "insert",
                  "return": "vehicle_id",
                  "table": "vehicles"
                },
                "target_column": "vehicle_id"
              },
              {
                "lookup": {
                  "match": {
                    "name": "stat"
                  },
                  "on_missing": "insert",
                  "return": "country_id",
                  "table": "countries"
                },
                "target_column": "country_id"
              },
              {
                "source_field": "datum_dovozu",
                "target_column": "import_date"
              }
            ],
            "kind": "fact"
          },
          "name": "imports",
          "primary_key": {
            "name": "import_id",
            "type": "serial"
          }
        }
      ]
    },
    "kind": "sqlite"
  },
  "transform": [
    {
      "kind": "coerce",
      "options": {
        "layout": "02.01.2006",
        "types": {
          "datum_dovozu": "date",
          "pcv": "bigint",
          "stat": "text"
        }
      }
    },
    {
      "kind": "validate",
      "options": {
        "contract": {
          "fields": [
            {
              "name": "pcv",
              "required": true,
              "type": "bigint"
            },
            {
              "name": "stat",
              "required": true,
              "type": "text"
            },
            {
              "layout": "02.01.2006",
              "name": "datum_dovozu",
              "type": "date"
            }
          ],
          "name": "vozidla_dovoz"
        },
        "policy": "lenient"
      }
    }
  ]
}
