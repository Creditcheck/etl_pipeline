{
  "job": "ros02_provozovny",
  "parser": {
    "kind": "csv",
    "options": {
      "comma": ",",
      "expected_fields": 10,
      "has_header": true,
      "header_map": {
        "DAPPSÄŒ": "dapps",
        "DAPRUIAN": "dapruian",
        "DAPTEXT": "daptext",
        "DATPLAT": "datplat",
        "DATUKON": "datukon",
        "DATZAH": "datzah",
        "ICO": "ico",
        "ICP": "icp",
        "PKODADM": "pkodadm",
        "PTEXTADR": "ptextadr"
      },
      "trim_space": true
    }
  },
  "runtime": {
    "batch_size": 4096,
    "channel_buffer": 1024,
    "debug_timings": false,
    "dedupe_dimension_keys": false,
    "dedupe_dimension_keys_within_batch": true,
    "loader_workers": 3,
    "reader_workers": 1,
    "transform_workers": 3,
    "validate_log_first_n": 25
  },
  "source": {
    "file": {
      "path": "/home/zippy/projects/data/szrcr.cz_aktivni_provozovny_ros.csv"
    },
    "kind": "file"
  },
  "storage": {
    "db": {
      "dsn": "postgresql://user:password@0.0.0.0:5432/testdb?sslmode=disable",
      "mode": "multi_table",
      "tables": [
        {
          "auto_create_table": true,
          "columns": [
            {
              "name": "ico",
              "nullable": false,
              "type": "text"
            }
          ],
          "constraints": [
            {
              "columns": [
                "ico"
              ],
              "kind": "unique"
            }
          ],
          "load": {
            "cache": {
              "key_column": "ico",
              "prewarm": false,
              "value_column": "company_id"
            },
            "conflict": {
              "action": "do_nothing",
              "target_columns": [
                "ico"
              ]
            },
            "from_rows": [
              {
                "source_field": "ico",
                "target_column": "ico"
              }
            ],
            "kind": "dimension",
            "returning": [
              "company_id",
              "ico"
            ]
          },
          "name": "public.company",
          "primary_key": {
            "name": "company_id",
            "type": "serial"
          }
        },
        {
          "auto_create_table": true,
          "columns": [
            {
              "name": "company_id",
              "nullable": true,
              "references": "public.company(company_id)",
              "type": "int"
            },
            {
              "name": "row_hash",
              "nullable": false,
              "type": "text"
            },
            {
              "name": "icp",
              "nullable": false,
              "type": "text"
            },
            {
              "name": "datzah",
              "nullable": true,
              "type": "date"
            },
            {
              "name": "datukon",
              "nullable": true,
              "type": "date"
            },
            {
              "name": "pkodadm",
              "nullable": true,
              "type": "text"
            },
            {
              "name": "ptextadr",
              "nullable": true,
              "type": "text"
            },
            {
              "name": "dapruian",
              "nullable": true,
              "type": "text"
            },
            {
              "name": "daptext",
              "nullable": true,
              "type": "text"
            },
            {
              "name": "dapps",
              "nullable": true,
              "type": "text"
            },
            {
              "name": "datplat",
              "nullable": true,
              "type": "date"
            }
          ],
          "constraints": [
            {
              "columns": [
                "row_hash"
              ],
              "kind": "unique"
            },
            {
              "columns": [
                "icp"
              ],
              "kind": "unique"
            }
          ],
          "load": {
            "dedupe": {
              "action": "do_nothing",
              "conflict_columns": [
                "row_hash"
              ]
            },
            "from_rows": [
              {
                "lookup": {
                  "match": {
                    "ico": "ico"
                  },
                  "on_missing": "insert",
                  "return": "company_id",
                  "table": "public.company"
                },
                "target_column": "company_id"
              },
              {
                "source_field": "row_hash",
                "target_column": "row_hash"
              },
              {
                "source_field": "icp",
                "target_column": "icp"
              },
              {
                "source_field": "datzah",
                "target_column": "datzah"
              },
              {
                "source_field": "datukon",
                "target_column": "datukon"
              },
              {
                "source_field": "pkodadm",
                "target_column": "pkodadm"
              },
              {
                "source_field": "ptextadr",
                "target_column": "ptextadr"
              },
              {
                "source_field": "dapruian",
                "target_column": "dapruian"
              },
              {
                "source_field": "daptext",
                "target_column": "daptext"
              },
              {
                "source_field": "dapps",
                "target_column": "dapps"
              },
              {
                "source_field": "datplat",
                "target_column": "datplat"
              }
            ],
            "kind": "fact"
          },
          "name": "public.ros02_provozovny",
          "primary_key": {
            "name": "ros02_provozovny_id",
            "type": "serial"
          }
        }
      ]
    },
    "kind": "postgres"
  },
  "transform": [
    {
      "kind": "coerce",
      "options": {
        "layout": "2006-01-02",
        "types": {
          "datplat": "date",
          "datukon": "date",
          "datzah": "date"
        }
      }
    },
    {
      "kind": "hash",
      "options": {
        "algorithm": "sha256",
        "encoding": "hex",
        "fields": [
          "icp",
          "ico",
          "datzah",
          "datukon",
          "pkodadm",
          "ptextadr",
          "dapruian",
          "daptext",
          "dapps",
          "datplat"
        ],
        "include_field_names": true,
        "overwrite": true,
        "separator": "\u001f",
        "target_field": "row_hash",
        "trim_space": true
      }
    },
    {
      "kind": "validate",
      "options": {
        "contract": {
          "fields": [
            {
              "name": "icp",
              "required": true,
              "type": "text"
            },
            {
              "name": "ico",
              "type": "text"
            },
            {
              "layout": "2006-01-02",
              "name": "datzah",
              "type": "date"
            },
            {
              "layout": "2006-01-02",
              "name": "datukon",
              "type": "date"
            },
            {
              "layout": "2006-01-02",
              "name": "datplat",
              "type": "date"
            },
            {
              "name": "pkodadm",
              "type": "text"
            },
            {
              "name": "ptextadr",
              "type": "text"
            },
            {
              "name": "dapruian",
              "type": "text"
            },
            {
              "name": "daptext",
              "type": "text"
            },
            {
              "name": "dapps",
              "type": "text"
            },
            {
              "name": "row_hash",
              "required": true,
              "type": "text"
            }
          ],
          "name": "ros02_provozovny"
        },
        "policy": "lenient"
      }
    }
  ]
}
